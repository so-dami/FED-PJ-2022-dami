<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>JS비동기: 3. Promise 적용연습1</title>
        <script>
            /*********************************************************
             
                [프라미스(Promise)란? "원하는 결과를 보장해! 약속해!"]

                    "생성코드"는 시간이 걸릴 수 있는 코드이다.
                    "사용코드"는 결과를 기다려야 하는 코드이다.
                    Promise는 생성 코드와 소비 코드를 연결하는 JavaScript 객체다!
                    ___________________________________________________
                    
                    ((구문))
                    let 약속변수 = new Promise(function(성공함수, 실패함수) {
                        // 생성코드 : 시간이 걸리는 코드
                        
                        성공함수(리턴값 사용가능); // 성공 시 호출
                        실패함수(리턴값 사용가능); // 에러 시 호출
                    });

                    // 사용코드 : 약속객체가 완료될때까지 기다림!!!
                    약속변수.then(
                        function(변수) { 성공 시 코드 },
                        function(변수) { 실패 시 코드 }
                        );
                        
                    ___________________________________________________

[ AJAX 비동기 파일처리 전송객체 ]

AJAX (Asynchronous Javascript And XML)
-> XMLHttpRequest

1. 특징:
    (1) 웹서버의 데이터 읽기(페이지 로드 후)
    (2) 페이지를 리로드하지 않고 웹페이지를 부분 업데이트함
    (3) 백그라운드 웹서버로 데이터 전송기능

2. 사용법:
    (1) 인스턴스를 생성하고 변수에 할당하여 사용
        ex) let ajax = new XMLHttpRequest();

    (2) 인스턴스를 열어서 전송 준비를 함
    - open(방식,요청URL,아이디,비밀번호,비동기옵션)
    -> 핵심: open(방식,요청URL)

        1) 방식: GET, POST
        - GET 방식을 더 선호함
        - 이유? 가볍고 빠르게 처리할 수 있기 때문
        - POST 방식은 민감한 데이터 처리 시 사용

        2) 요청URL:
        - 웹서버의 페이지나 파일경로주소

        3) 아이디, 비번:
        - 웹서버 접근 시 인증이 필요한 경우 사용

        4) 비동기옵션:
        - 기본값 true
        -> 아무것도 안 쓰면 true로 비동기처리됨
        -> 만약 false라고 하면 동기적처리를 함

        - 비동기적으로 처리해야 페이지가 멈추지 않고 요청파일만 별도로 처리할 수 있음
        
        ex) ajax.open("GET","https://my.com/my.pdf")
    
    (3) 전송 후 처리를 위한 로드함수구역 설정
    - 인스턴스변수.onload = function(){처리소스};

    -> 여기서 onload라는 것은 서버에서 결과를 로드한다는 의미임
    -> 결과처리 상태값: 인스턴스변수.status 값으로 처리함

        [ status 결과값 종류 ]
        
        - 200: "OK" - 처리완료
        - 403: "Forbidden" - 파일접근거부
        - 404: "Not Found" - 파일없음
        - statusText로 받으면 위의 문자형으로 리턴함

        [ response 결과내용 종류 ]
        
        - responseText: 데이터를 문자형식으로 받기
        - responseXML: 데이터를 XML형식으로 받기
        - responseURL: 데이터 전송 URL로 받기

    (4) 오픈 셋팅된 요청객체를 전송함
    - 인스턴스변수.send()
    -> open() -> onload -> send() 순으로 코딩

[ 웹서버 파일 요청 시 주의사항 ]

1. 요청한 파일이 현재 페이지의 도메인 주소와 다른 경우(이종도메인) XSS 공격 등의 이유로 브라우저에서 이것을 금지하고 있음
(일반 XMLHttpRequest 요청으로 가져오는 것은 가능)

2. Promise를 사용하여 파일을 요청하고 에러 발생 시 이것을 실패함수로 처리할 때 이종도메인 에러는 Promise의 에러도 함께 발생시키므로, 실패함수처리가 되지 않음

3. 이것은 근본적인 브라우저 정책이므로 해결방법은 같은 도메인의 파일을 요청하는 것(외부도메인 파일을 같은 서버에 저장하여 사용하는 경우가 多)
            **********************************************************/
function 화면뿌려(이거) {
document.getElementById("show").innerHTML += 이거 + "<br>";
}

// 로딩구역 //
window.addEventListener("load", () => {

    // 제이슨 데이터를 로딩하여 읽은 후
    // 데이터를 활용하도록 Promise를 적용한다.

    // 1. 변수 = new Promise((성공함수)=>{코드})
    // 프라미스 코드에 XMLHttpRequest() 객체로 제이슨 로딩
    const myProm = new Promise((prFn)=>{
    // prFn - 성공함수

        // 1-1. XMLHttpRequest() 객체 인스턴스 생성하기
        let ajax = new XMLHttpRequest();

        // 1-2. 비동기 파일 요청(JSON 파일 요청)
        ajax.open("GET","./defaultSettings.json");
        // -> JSON 파일은 응답형식(responseType)을 "json" 설정 필수
        ajax.responseType = "json";

        // 1-3. 결과 리턴 onload 이벤트 함수 구역 만들기
        ajax.onload = function(){

            console.log(ajax.status);
            if(ajax.status == 200){

                // 프라미스 성공함수로 제이슨 데이터 전달하기
                prFn(ajax.response);
                // responseType을 "json"으로 설정했으므로 결과값은 json으로 전달됨
                
            } // if //
            
            else{

                console.log(ajax.statusText);
                
            } // else //
            
        }; // onload 함수구역 //

        // 1-4. 비동기요청 보내기
        ajax.send();
        
    }); // myProm 인스턴스 //

    // 2. Promise변수.then(()=>{코드})
    // 성공한 제이슨 로딩파일을 전달 받아 활용
    myProm.then(success=>{
    // success - 성공 시 전달변수

        console.log("전달파일찍기:",success);

        
    }); // myProm then //
    
}); // load //

</script>
<style>
@import url("https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap");

body {
    background-image: linear-gradient(to bottom, #494949, gray);
    background-repeat: no-repeat;
    background-attachment: fixed;
    text-align: center;
}

#show {
    font-family: "Gamja Flower", cursive;
    font-size: 4vw;
    background-image: linear-gradient(to bottom, lightgreen, pink, orangered, aquamarine);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-repeat: no-repeat;
    font-weight: bold;
}

#doc {
    width: 50%;
    height: 50vh;
    margin: 0 auto;
}
</style>
</head>
<body>
    <div id="show"></div>
    <div id="doc"></div>
</body>
</html>
